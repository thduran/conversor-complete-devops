# alerting:
#       alertmanagers:
#         - static_configs:
#             - targets: ["alertmanager.monitoring.svc.cluster.local:9093"]

#     rule_files:
#       - /etc/rules/*.yaml

#     scrape_configs:
#       - job_name: "prometheus"
#         static_configs:
#           - targets: ["localhost:9090"]

#       - job_name: "fake"   # fake target just to trigger InstanceDown
#         static_configs:
#           - targets: ["fake:1234"]
      
#       - job_name: "conversor-api"
#         metrics_path: /metrics
#         static_configs:
#           - targets: 
#             - "conversor.staging.svc.cluster.local:80"
#             - "conversor.production.svc.cluster.local:80"

apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: monitoring
data:
  prometheus.yaml: |
    global:
      scrape_interval: 15s

    scrape_configs:
      - job_name: 'kubernetes-pods'
        kubernetes_sd_configs:
        - role: pod
        
        relabel_configs:
        - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
          action: keep
          regex: true
        - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
          action: replace
          target_label: __metrics_path__
          regex: (.+)
        - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
          action: replace
          regex: ([^:]+)(?::\d+)?;(\d+)
          replacement: $1:$2
          target_label: __address__
        - action: labelmap
          regex: __meta_kubernetes_pod_label_(.+)
        - source_labels: [__meta_kubernetes_namespace]
          action: replace
          target_label: namespace
        - source_labels: [__meta_kubernetes_pod_name]
          action: replace
          target_label: pod    